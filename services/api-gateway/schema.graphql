# GraphQL Schema pour l'API Gateway

# ============================================
# TYPES
# ============================================

# Représente un utilisateur
type User {
  id: ID!
  email: String!
  name: String!
  role: String!
  createdAt: Int!
  lastLogin: Int
  isActive: Boolean!
}

# Payload de réponse pour l'authentification
type AuthPayload {
  token: String!
  user: User!
}

# Représente un appareil IoT
type Device {
  id: ID!
  name: String!
  type: String!
  status: DeviceStatus!
  createdAt: Int!
  lastSeen: Int!
  metadata: [MetadataEntry!]!
}

# Entrée clé-valeur pour les métadonnées
type MetadataEntry {
  key: String!
  value: String!
}

# Statut d'un device
enum DeviceStatus {
  UNKNOWN
  ONLINE
  OFFLINE
  ERROR
  MAINTENANCE
}

# ============================================
# TELEMETRY TYPES
# ============================================

# Point de télémétrie
type TelemetryPoint {
  time: Int!
  value: Float!
  unit: String
}

# Série de télémétrie
type TelemetrySeries {
  metricName: String!
  points: [TelemetryPoint!]!
}

# Agrégation de télémétrie (pour graphiques)
type TelemetryAggregation {
  bucket: String!
  avg: Float!
  min: Float!
  max: Float!
  count: Int!
}

# ============================================
# INPUTS (pour les mutations)
# ============================================

# Input pour l'enregistrement d'un utilisateur
input RegisterInput {
  email: String!
  password: String!
  name: String!
  role: String
}

# Input pour la connexion
input LoginInput {
  email: String!
  password: String!
}

# Input pour créer un device
input CreateDeviceInput {
  name: String!
  type: String!
  metadata: [MetadataEntryInput!]
}

# Input pour une entrée de métadonnée
input MetadataEntryInput {
  key: String!
  value: String!
}

# Input pour mettre à jour un device
input UpdateDeviceInput {
  id: ID!
  name: String
  status: DeviceStatus
  metadata: [MetadataEntryInput!]
}

# ============================================
# QUERIES (Lecture)
# ============================================

type Query {
  # Récupérer l'utilisateur actuellement connecté
  me: User

  # Lister tous les utilisateurs avec pagination (admin only)
  users(
    page: Int = 1
    pageSize: Int = 20
    role: String
  ): UserConnection!

  # Récupérer un device par son ID
  device(id: ID!): Device

  # Lister tous les devices avec pagination
  devices(
    page: Int = 1
    pageSize: Int = 20
    type: String
    status: DeviceStatus
  ): DeviceConnection!

  # Statistiques globales
  stats: Stats!

  # ============================================
  # TELEMETRY QUERIES
  # ============================================

  # Données de télémétrie brutes d'un device
  deviceTelemetry(
    deviceId: ID!
    metricName: String!
    from: Int!
    to: Int!
    limit: Int = 1000
  ): TelemetrySeries!

  # Données agrégées (pour graphiques)
  deviceTelemetryAggregated(
    deviceId: ID!
    metricName: String!
    from: Int!
    to: Int!
    interval: String!
  ): [TelemetryAggregation!]!

  # Dernière valeur d'une métrique
  deviceLatestMetric(
    deviceId: ID!
    metricName: String!
  ): TelemetryPoint

  # Liste des métriques disponibles pour un device
  deviceMetrics(deviceId: ID!): [String!]!
}

# Connexion pour la pagination des utilisateurs
type UserConnection {
  users: [User!]!
  total: Int!
  page: Int!
  pageSize: Int!
}

# Connexion pour la pagination des devices
type DeviceConnection {
  devices: [Device!]!
  total: Int!
  page: Int!
  pageSize: Int!
}

# Statistiques
type Stats {
  totalDevices: Int!
  onlineDevices: Int!
  offlineDevices: Int!
  errorDevices: Int!
}

# ============================================
# MUTATIONS (Écriture)
# ============================================

type Mutation {
  # Enregistrer un nouvel utilisateur
  register(input: RegisterInput!): AuthPayload!

  # Se connecter
  login(input: LoginInput!): AuthPayload!

  # Créer un nouveau device
  createDevice(input: CreateDeviceInput!): Device!

  # Mettre à jour un device
  updateDevice(input: UpdateDeviceInput!): Device!

  # Supprimer un device
  deleteDevice(id: ID!): DeleteResult!
}

# Résultat d'une suppression
type DeleteResult {
  success: Boolean!
  message: String!
}

# ============================================
# SUBSCRIPTIONS (Temps réel)
# ============================================

type Subscription {
  # Recevoir les updates des devices en temps réel
  deviceUpdated: Device!

  # Recevoir les données de télémétrie en temps réel pour un device
  telemetryReceived(deviceId: ID!): TelemetryPoint!
}
